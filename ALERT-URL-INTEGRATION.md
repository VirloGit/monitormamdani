# Alert URL Integration - Implementation Guide

## What Was Implemented

The system now automatically saves Notable Alerts generated by Claude AI to Supabase with article URLs, which are then included in the weekly digest emails.

## Changes Made

### 1. Database Schema Update
**File:** `supabase-add-url-field.sql`

Added two new fields to the `notable_alerts` table:
- `url` (TEXT) - Stores the article/video URL that inspired the alert
- `source` (TEXT) - Stores the source name (e.g., "Politico", "YouTube")

**Action Required:** Run this SQL in your Supabase SQL Editor:
```sql
ALTER TABLE notable_alerts ADD COLUMN url TEXT;
ALTER TABLE notable_alerts ADD COLUMN source TEXT;
```

### 2. Claude Alerts Endpoint Enhancement
**File:** `api/claude-alerts.mjs`

**Changes:**
- Added Supabase credentials (`SUPBASE_URL`, `SUPABASE_KEY`)
- Implemented `enrichAlertsWithUrls()` function that:
  - Matches alert titles with news/video titles using keyword matching
  - Attaches the URL and source from the matching news article or video
- Implemented `saveAlertsToSupabase()` function that:
  - Automatically saves all generated alerts to Supabase
  - Saves asynchronously (non-blocking) so it doesn't slow down the API response
  - Marks alerts as `sent_in_digest: false` by default

**How It Works:**
1. Claude generates alerts based on videos, news, and markets
2. For each alert, the system searches for news articles or videos with matching keywords
3. If a match is found, the alert gets enriched with the URL and source
4. All alerts (with or without URLs) are saved to Supabase
5. The enriched alerts are returned to the frontend for display

### 3. Weekly Digest Email Update
**File:** `api/send-weekly-digest.mjs`

**Changes:**
- Updated the email template to include article URLs
- For each alert with a URL, adds a "â†’ Read more" link below the description
- Links are styled in blue (#0066cc) with proper formatting

**Email Output Example:**
```
ðŸ“ˆ Trends

â€¢ Mamdani's Rent Freeze Market Shows Momentum: Prediction market odds moved from 42% to 51%.
  â†’ Read more
```

## How the System Works End-to-End

### Daily Alert Generation (Every 5 Minutes)
1. Frontend (`app.js` line 383-411) calls `/api/claude-alerts` with latest videos, news, and markets
2. Claude AI analyzes the data and generates 2-4 notable alerts
3. System enriches alerts with URLs by matching keywords from news/videos
4. Alerts are automatically saved to Supabase `notable_alerts` table
5. Frontend displays alerts on the homepage

### Weekly Digest (Every Sunday 9 AM UTC)
1. GitHub Action triggers `/api/send-weekly-digest`
2. Fetches all unsent alerts from previous Mon-Fri (where `sent_in_digest: false`)
3. Groups alerts by type (TREND, OPPORTUNITY, RISK, MOMENTUM)
4. Formats email with bullet points, including "â†’ Read more" links for alerts with URLs
5. Sends via Buttondown to subscribers with `weekly_digest` tag
6. Marks alerts as `sent_in_digest: true` to prevent duplicate sends

## URL Matching Logic

The `enrichAlertsWithUrls()` function uses a simple but effective keyword matching algorithm:

1. Extracts words from alert title (4+ characters only)
2. Searches news articles for titles containing any of those keywords
3. If found, uses that article's URL
4. If not in news, searches videos the same way
5. If no match found, alert is saved without a URL (still appears in digest, just no link)

**Example:**
- Alert title: "Rent Freeze Market Shows Momentum"
- Keywords: ["rent", "freeze", "market", "shows", "momentum"]
- Finds news article: "NYC Rent Freeze Initiative Gains Support"
- URL attached: https://www.politico.com/news/2026/01/10/nyc-rent-freeze

## Testing

### Test the Alert Saving
1. Open the homepage: https://monitormamdani.com
2. Wait for alerts to load (check browser console for `/api/claude-alerts` request)
3. Check Supabase `notable_alerts` table - should see new alerts with URLs
4. Verify `sent_in_digest` is `false` for new alerts

### Test the Weekly Digest
```bash
curl -X POST https://monitormamdani.com/api/send-weekly-digest \
  -H "Content-Type: application/json" \
  -d '{}'
```

Check your email for:
- Alerts grouped by type
- "â†’ Read more" links below each alert (if URL exists)
- Links are clickable and styled in blue

### Test with Sample Data
Use the existing test endpoint:
```bash
curl -X POST https://monitormamdani.com/api/test-send-emails \
  -H "Content-Type: application/json" \
  -d '{}'
```

## Monitoring

### Check Saved Alerts
```sql
SELECT
    type,
    title,
    url,
    source,
    sent_in_digest,
    created_at
FROM notable_alerts
ORDER BY created_at DESC
LIMIT 10;
```

### Check Alerts with URLs
```sql
SELECT
    COUNT(*) as total_alerts,
    COUNT(url) as alerts_with_urls,
    ROUND(COUNT(url)::numeric / COUNT(*) * 100, 1) as url_percentage
FROM notable_alerts
WHERE created_at >= NOW() - INTERVAL '7 days';
```

### Check Unsent Alerts for Next Digest
```sql
SELECT type, title, url
FROM notable_alerts
WHERE sent_in_digest = false
AND created_at >= DATE_TRUNC('week', NOW() - INTERVAL '7 days') + INTERVAL '1 day'  -- Last Monday
AND created_at <= DATE_TRUNC('week', NOW() - INTERVAL '7 days') + INTERVAL '5 days'  -- Last Friday
ORDER BY type, created_at DESC;
```

## Troubleshooting

### No URLs in Alerts
**Problem:** Alerts are saved but `url` field is NULL

**Possible Causes:**
1. No matching news/videos found (keyword matching failed)
2. News/videos don't have URL fields populated
3. Alert titles are too generic (no good keywords)

**Solution:** Check the source data quality - make sure news and videos are being fetched properly

### Alerts Not Saving to Supabase
**Problem:** Alerts display on site but don't appear in database

**Check:**
1. Verify `SUPBASE_URL` and `SUPABASE_KEY` are set in Netlify environment variables
2. Check Netlify function logs for errors
3. Verify Supabase table permissions allow INSERT

### Duplicate Alerts in Digest
**Problem:** Same alert sent in multiple digests

**Check:**
1. Verify `sent_in_digest` is being updated to `true` after sending
2. Check the date range logic in weekly digest query

## Future Enhancements

Potential improvements:
1. **Better URL Matching:** Use fuzzy matching or NLP for more accurate URL assignment
2. **Manual URL Entry:** Admin UI to manually assign URLs to alerts without them
3. **Source Prioritization:** Prefer certain news sources (e.g., NYTimes > Blog)
4. **URL Validation:** Check that URLs are still live before sending in digest
5. **Multiple URLs:** Allow multiple source URLs per alert
6. **Alert Categories:** Track which topics generate most alerts

## Summary

The integration is complete and automated:
- âœ… Alerts automatically saved to Supabase with URLs
- âœ… Weekly digest includes article links
- âœ… Non-blocking saves (doesn't slow down the site)
- âœ… Works with existing alert generation pipeline
- âœ… No manual intervention required

The system will now automatically populate the weekly digest with real article URLs as Claude generates alerts throughout the week.
